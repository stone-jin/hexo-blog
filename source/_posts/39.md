---
title: 搭建自己的gitlab服务以及gitlab-ci的开发模式
cover: https://img.zcool.cn/community/011e475b86a540a80120245c336724.jpg@1280w_1l_2o_100sh.jpg
subtitle: 搭建GitLab服务以及Gitlab-CI开发模式
date: 2018-07-10 13:13:20
author: 
  nick: 金炳
  link: https://www.github.com/stone-jin
categories:
- 工程化
tags:
- Gitlab
- 工程化
---

## 一、简介
本地我自己肯定是搭建了自己的gitlab仓库的。这次主要是出于gitlab-ci的考虑，想要在把原本自己的ci流程，从本地的jenkins转义到gitlab-ci上，只需要提交代码，就能部署到我自己的服务器上面，并且希望是能区分预发布服和线上服两种环境，本地就当开发环境了。测试环境就不搞了，预发布就当测试环境用好了。所以本次目的，就是在自己的阿里云上面搭建自己的gitlab服务，域名就选择使用gitlab.fedfans.com这个域名好了。

## 二、搭建过程
搭建过程主要涉及到几步：
- docker环境搭建（因为拿的是新的一台阿里云机器）
- gitlab docker镜像运行
- 然后gitlab-ci的runner搭建
- 测试整个gitlab-ci的流程

第一步：

docker官方提供了centos环境里面怎么安装docker。[https://docs.docker.com/install/linux/docker-ce/centos/](https://docs.docker.com/install/linux/docker-ce/centos/)

第二步:

gitlab官方提供了如果使用docker安装gitlab的环境。

第三步:

3.1 根据环境安装gitlab runner, [https://docs.gitlab.com/runner/](https://docs.gitlab.com/runner/)

3.2 然后使用linux的安装方法。[https://docs.gitlab.com/runner/install/linux-manually.html](https://docs.gitlab.com/runner/install/linux-manually.html)

3.3 然后我们使用gitlab-runner register

他会提示我们输入gitlab地址，这个在项目的CI/CD pipelines上面有个url和token我们分别输入到gitlab-runner register中，同时使用shell模式

3.4 然后会在当前这个目录下生成一个config.toml文件

3.5 我们修改这个config.toml文件

```text
concurrent = 1修改为concurrent=8
```

3.6 然后我们使用这个shell脚本进行启动
```text
#! /bin/sh
# chkconfig: - 99 01
# description: GitLab Runner
# processname: /usr/bin/gitlab-ci-multi-runner

# Source function library.
. /etc/rc.d/init.d/functions

name="yydbhz"
desc="yydbhz"
user=""
cmd=/home/root/.gitlab-runner/gitlab-runner
args=" "run" "--working-directory" "/home/root/.gitlab-runner" "--config" "/home/root/.gitlab-runner/config.toml" "--service" "gitlab-runner"  "--syslog""
lockfile=/home/root/.gitlab-runner/$name
pidfile=/home/root/.gitlab-runner/$name.pid

# Source networking configuration.
[ -r /etc/sysconfig/$name ] && . /etc/sysconfig/$name

start() {
    echo -n $"Starting $desc: "
    daemon \
         \
         \
        "$cmd $args </dev/null >/dev/null 2>/dev/null & echo \$! > $pidfile"
    retval=$?
    [ $retval -eq 0 ] && touch $lockfile
    echo
    return $retval
}

stop() {
    echo -n $"Stopping $desc: "
    killproc -p $pidfile $cmd -TERM
    retval=$?
    [ $retval -eq 0 ] && rm -f $lockfile
    rm -f $pidfile
    echo
    return $retval
}

restart() {
    stop
    start
}

reload() {
    echo -n $"Reloading $desc: "
    killproc -p $pidfile $cmd -HUP
    RETVAL=$?
    echo
}

force_reload() {
    restart
}

rh_status() {
    status -p $pidfile $cmd
}

rh_status_q() {
    rh_status >/dev/null 2>&1
}

case "$1" in
    start)
        rh_status_q && exit 0
        $1
        ;;
    stop)
        rh_status_q || exit 0
        $1
        ;;
    restart)
        $1
        ;;
    reload)
        rh_status_q || exit 7
        $1
        ;;
    force-reload)
        force_reload
        ;;
    status)
        rh_status
        ;;
    condrestart|try-restart)
        rh_status_q || exit 0
        ;;
    *)
        echo $"Usage: $0 {start|stop|status|restart|condrestart|try-restart|reload|force-reload}"
        exit 2
esac
```
然后我们使用这个脚本进行启动。

最终gitlab-ci搭建完毕。

然后gitlab-ci的使用，我们后面讲解下。

## 三、总结
jenkins的流程，用了不少时间了，关于工程化个人也是比较熟练了。然后本次呢主要想要更快更敏捷的开发，同时在ci的流程中比如将部署还能选择预发布和线上这种区分，所以很方便，虽然放到阿里云服务器，带来的是上传代码变慢，这个总能解决。
